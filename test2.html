<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fetch Photo from Google Sheet (Debug Mode)</title>

  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      text-align: center;
      padding: 20px;
    }
    input,
    button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #0078d4;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #005fa3;
    }
    img {
      margin-top: 20px;
      border-radius: 10px;
      border: 2px solid #ccc;
    }
  </style>
</head>

<body>
  <h2>üì∏ Google Sheet ‡§∏‡•á ‡§´‡•ã‡§ü‡•ã ‡§≤‡§æ‡§®‡§æ (Debug Mode)</h2>

  <input type="text" id="idInput" placeholder="Enter Roll Number" />
  <button onclick="searchCertificate()">Fetch Photo</button>

  <p id="message"></p>

  <img id="previewImage" style="display: none; max-width: 300px" />
  <img
    id="croppedImage"
    style="display: none; max-width: 200px; margin-top: 10px"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script>
    let cropper;

    // üß© Google Sheet Info
    const API_KEY = "AIzaSyA2UyAU-6qR-nwwfauzdFG-CxhpVSSh8yw";
    const SPREADSHEET_ID = "1q9KL8CBHjPuhPohyTcGp9wk68VxkJ6OT8DZrRctwRyI";
    const SHEET_NAME = "Sheet2";

    async function searchCertificate() {
      const idInput = document.getElementById("idInput").value.trim();
      const message = document.getElementById("message");
      const photoElement = document.getElementById("previewImage");
      const photopreview = document.getElementById("croppedImage");

      if (!idInput) {
        message.innerText = "‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!";
        console.log("Roll number not entered.");
        return;
      }

      try {
        message.innerText = "Fetching photo...";
        console.log("Fetching data from Google Sheet...");

        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
        console.log("Fetching URL:", url);

        const response = await fetch(url);
        const data = await response.json();

        console.log("Raw Sheet Data:", data);

        if (!data.values || data.values.length === 0) {
          message.innerText = "Google Sheet ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";
          console.log("No data found in the sheet.");
          return;
        }

        const headers = data.values[0];
        console.log("Sheet Headers:", headers);

        const rollIndex = headers.indexOf("Ms_Nub");
        const urlIndex = headers.indexOf("photourl");

        console.log("Ms_Nub index:", rollIndex, "photourl index:", urlIndex);

        if (rollIndex === -1 || urlIndex === -1) {
          message.innerText = "Ms_Nub ‡§Ø‡§æ photourl ‡§ï‡•â‡§≤‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";
          console.log("Required columns not found in headers.");
          return;
        }

        // ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§∏‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ñ‡•ã‡§ú‡•ã
        const record = data.values.find((row, i) => i > 0 && row[rollIndex] === idInput);
        console.log("Matched Record:", record);

        if (!record) {
          message.innerText = "‚ùå ‡§á‡§∏ ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";
          console.log("No record found for roll number:", idInput);
          return;
        }

        let rawLink = record[urlIndex];
        console.log("Raw Google Drive Link:", rawLink);

        if (!rawLink) {
          message.innerText = "Google Drive ‡§≤‡§ø‡§Ç‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";
          console.log("Google Drive link missing for this record.");
          return;
        }

        // Google Drive File ID ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ
        let fileIdMatch = rawLink.match(/\/d\/([a-zA-Z0-9_-]+)/);
        let fileId = fileIdMatch ? fileIdMatch[1] : null;

        if (!fileId) {
          const idMatch = rawLink.match(/[?&]id=([a-zA-Z0-9_-]+)/);
          if (idMatch && idMatch[1]) fileId = idMatch[1];
        }

        console.log("Extracted File ID:", fileId);

        if (fileId) {
          const imageUrl = `https://lh3.googleusercontent.com/d/${fileId}=s800`;
          console.log("Final Image URL:", imageUrl);

          photoElement.src = imageUrl;
          photopreview.src = imageUrl;
          photoElement.style.display = "block";
          photopreview.style.display = "block";
          message.innerText = "‚úÖ ‡§´‡•ã‡§ü‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à ‡§π‡•à!";

          if (cropper) cropper.destroy();
          cropper = new Cropper(photoElement, {
            viewMode: 1,
            autoCropArea: 0.8,
            crop() {
              const canvas = cropper.getCroppedCanvas({
                width: 200,
                height: 200,
              });
              photopreview.src = canvas.toDataURL();
              console.log("Cropper updated.");
            },
          });
        } else {
          message.innerText = "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø Google Drive URL‡•§";
          console.log("Invalid Google Drive URL format:", rawLink);
        }
      } catch (err) {
        console.error("Error:", err);
        message.innerText = "‚ö†Ô∏è ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§";
      }
    }

    // ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§ï‡•á ‡§∏‡§Æ‡§Ø URL ‡§∏‡•á ‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§î‡§∞ ‡§ë‡§ü‡•ã fetch ‡§ï‡§∞‡•ã
    window.onload = function () {
      const urlParams = new URLSearchParams(window.location.search);
      const idInput = urlParams.get("roll");
      if (idInput) {
        document.getElementById("idInput").value = idInput;
        searchCertificate();
      }
    };
  </script>
</body>
</html>
